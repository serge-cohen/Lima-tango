//=============================================================================
//
// file :        XpadPixelDetector.h
//
// description : Include for the XpadPixelDetector class.
//
// project :	XPAD Pixel Detector from Lima
//
// $Author:  $
//
// $Revision:  $
// $Date:  $
//
// SVN only:
// $HeadURL: $
//
// CVS only:
// $Source:  $
// $Log:  $
//
// copyleft :    Synchrotron SOLEIL 
//               L'Orme des merisiers - Saint Aubin
//		 BP48 - 91192 Gif sur Yvette
//               FRANCE
//
//=============================================================================
//
//  		This file is generated by POGO
//	(Program Obviously used to Generate tango Object)
//
//         (c) - Software Engineering Group - ESRF
//=============================================================================
#ifndef _XPADPIXELDETECTOR_H
#define _XPADPIXELDETECTOR_H

#include "tango.h"

#include "HwInterface.h"
#include "CtControl.h"
#include "CtAcquisition.h"
#include "CtImage.h"
#include <XpadInterface.h>
#include <XpadCamera.h>
#include "Factory.h"

//using namespace Tango;

/**
 * @author	$Author:  $
 * @version	$Revision:  $
 */

//	Add your own constant definitions here.
//-----------------------------------------------

using namespace std;

namespace XpadPixelDetector_ns
{

    /**
     * Class Description:
     * This is the Xpad 3.2 (PCIe) Pixel Detector device, which uses Lima
 */

/*
 *	Device States Description:
*  Tango::INIT :
*  Tango::STANDBY :
*  Tango::RUNNING :
*  Tango::FAULT :
*  Tango::DISABLE :  Xpad is calibrating
 */


    class XpadPixelDetector : public Tango::Device_4Impl
    {
    public:
        //	Add your own data members here
        //-----------------------------------------


        //	Here is the Start of the automatic code generation part
        //-------------------------------------------------------------	
        /**
         *	@name attributes
         *	Attribute member data.
         */
        //@{
		Tango::DevULong	attr_deadTime_write;
		Tango::DevULong	attr_init_write;
		Tango::DevULong	attr_shutter_write;
		Tango::DevULong	attr_ovf_write;
		Tango::DevULong	attr_n_write;
		Tango::DevULong	attr_p_write;
		Tango::DevULong	attr_busyOut_write;
		Tango::DevULong	attr_gp1_write;
		Tango::DevULong	attr_gp2_write;
		Tango::DevULong	attr_gp3_write;
		Tango::DevULong	attr_gp4_write;
		Tango::DevBoolean	attr_enableGeometricalCorrection_write;
		Tango::DevULong	*attr_dacl_read;
		Tango::DevULong	*attr_ithl_read;
//@}

        /**
         * @name Device properties
         * Device properties member data.
         */
        //@{
/**
 *	Type of Acquisition:<BR>
 *	SYNC -> Synchrone<BR>
 *	ASYNC-> Asynchrone<BR>
 */
	string	acquisitionType;
/**
 *	Define the model of the XPAD (architecture)<BR>
 *	Availables models :<BR>
 *	- BACKPLANE<BR>
 *	- IMXPAD_S70<BR>
 *	- IMXPAD_S140<BR>
 *	- IMXPAD_S340<BR>
 *	- IMXPAD_S540<BR>
 */
	string	xpadModel;
/**
 *	Path where the calibration files will be saved, and from where the calibrations will be uploaded via an UploadCalibration command
 */
	string	calibrationPath;
/**
 *	Number of Adjusting iteration for the Calibration
 */
	Tango::DevULong	calibrationAdjustingNumber;
//@}

        /**
         *	@name Device properties
         *	Device property member data.
         */
        //@{
        //@}

        /**@name Constructors
         * Miscellaneous constructors */
        //@{
        /**
         * Constructs a newly allocated Command object.
         *
         *	@param cl	Class.
         *	@param s 	Device Name
         */
        XpadPixelDetector(Tango::DeviceClass *cl, string &s);
        /**
         * Constructs a newly allocated Command object.
         *
         *	@param cl	Class.
         *	@param s 	Device Name
         */
        XpadPixelDetector(Tango::DeviceClass *cl, const char *s);
        /**
         * Constructs a newly allocated Command object.
         *
         *	@param cl	Class.
         *	@param s 	Device name
         *	@param d	Device description.
         */
        XpadPixelDetector(Tango::DeviceClass *cl, const char *s, const char *d);
        //@}

        /**@name Destructor
         * Only one destructor is defined for this class */
        //@{

                /**
         * The object destructor.
         */
        ~XpadPixelDetector()
        {
            delete_device();
        };
        /**
         *	will be called at device destruction or at init command.
         */
        void delete_device();
        //@}


        /**@name Miscellaneous methods */
        //@{
        /**
         *	Initialize the device
         */
        virtual void init_device();
        /**
         *	Always executed method before execution command method.
         */
        virtual void always_executed_hook();

//@}

/**
 * @name XpadPixelDetector methods prototypes
 */

//@{
/**
 *	Hardware acquisition for attributes.
 */
	virtual void read_attr_hardware(vector<long> &attr_list);
/**
 *	Extract real attribute values for deadTime acquisition result.
 */
	virtual void read_deadTime(Tango::Attribute &attr);
/**
 *	Write deadTime attribute values to hardware.
 */
	virtual void write_deadTime(Tango::WAttribute &attr);
/**
 *	Extract real attribute values for init acquisition result.
 */
	virtual void read_init(Tango::Attribute &attr);
/**
 *	Write init attribute values to hardware.
 */
	virtual void write_init(Tango::WAttribute &attr);
/**
 *	Extract real attribute values for shutter acquisition result.
 */
	virtual void read_shutter(Tango::Attribute &attr);
/**
 *	Write shutter attribute values to hardware.
 */
	virtual void write_shutter(Tango::WAttribute &attr);
/**
 *	Extract real attribute values for ovf acquisition result.
 */
	virtual void read_ovf(Tango::Attribute &attr);
/**
 *	Write ovf attribute values to hardware.
 */
	virtual void write_ovf(Tango::WAttribute &attr);
/**
 *	Extract real attribute values for n acquisition result.
 */
	virtual void read_n(Tango::Attribute &attr);
/**
 *	Write n attribute values to hardware.
 */
	virtual void write_n(Tango::WAttribute &attr);
/**
 *	Extract real attribute values for p acquisition result.
 */
	virtual void read_p(Tango::Attribute &attr);
/**
 *	Write p attribute values to hardware.
 */
	virtual void write_p(Tango::WAttribute &attr);
/**
 *	Extract real attribute values for busyOut acquisition result.
 */
	virtual void read_busyOut(Tango::Attribute &attr);
/**
 *	Write busyOut attribute values to hardware.
 */
	virtual void write_busyOut(Tango::WAttribute &attr);
/**
 *	Extract real attribute values for gp1 acquisition result.
 */
	virtual void read_gp1(Tango::Attribute &attr);
/**
 *	Write gp1 attribute values to hardware.
 */
	virtual void write_gp1(Tango::WAttribute &attr);
/**
 *	Extract real attribute values for gp2 acquisition result.
 */
	virtual void read_gp2(Tango::Attribute &attr);
/**
 *	Write gp2 attribute values to hardware.
 */
	virtual void write_gp2(Tango::WAttribute &attr);
/**
 *	Extract real attribute values for gp3 acquisition result.
 */
	virtual void read_gp3(Tango::Attribute &attr);
/**
 *	Write gp3 attribute values to hardware.
 */
	virtual void write_gp3(Tango::WAttribute &attr);
/**
 *	Extract real attribute values for gp4 acquisition result.
 */
	virtual void read_gp4(Tango::Attribute &attr);
/**
 *	Write gp4 attribute values to hardware.
 */
	virtual void write_gp4(Tango::WAttribute &attr);
/**
 *	Extract real attribute values for enableGeometricalCorrection acquisition result.
 */
	virtual void read_enableGeometricalCorrection(Tango::Attribute &attr);
/**
 *	Write enableGeometricalCorrection attribute values to hardware.
 */
	virtual void write_enableGeometricalCorrection(Tango::WAttribute &attr);
/**
 *	Extract real attribute values for dacl acquisition result.
 */
	virtual void read_dacl(Tango::Attribute &attr);
/**
 *	Extract real attribute values for ithl acquisition result.
 */
	virtual void read_ithl(Tango::Attribute &attr);
/**
 *	Read/Write allowed for deadTime attribute.
 */
	virtual bool is_deadTime_allowed(Tango::AttReqType type);
/**
 *	Read/Write allowed for init attribute.
 */
	virtual bool is_init_allowed(Tango::AttReqType type);
/**
 *	Read/Write allowed for shutter attribute.
 */
	virtual bool is_shutter_allowed(Tango::AttReqType type);
/**
 *	Read/Write allowed for ovf attribute.
 */
	virtual bool is_ovf_allowed(Tango::AttReqType type);
/**
 *	Read/Write allowed for n attribute.
 */
	virtual bool is_n_allowed(Tango::AttReqType type);
/**
 *	Read/Write allowed for p attribute.
 */
	virtual bool is_p_allowed(Tango::AttReqType type);
/**
 *	Read/Write allowed for busyOut attribute.
 */
	virtual bool is_busyOut_allowed(Tango::AttReqType type);
/**
 *	Read/Write allowed for gp1 attribute.
 */
	virtual bool is_gp1_allowed(Tango::AttReqType type);
/**
 *	Read/Write allowed for gp2 attribute.
 */
	virtual bool is_gp2_allowed(Tango::AttReqType type);
/**
 *	Read/Write allowed for gp3 attribute.
 */
	virtual bool is_gp3_allowed(Tango::AttReqType type);
/**
 *	Read/Write allowed for gp4 attribute.
 */
	virtual bool is_gp4_allowed(Tango::AttReqType type);
/**
 *	Read/Write allowed for enableGeometricalCorrection attribute.
 */
	virtual bool is_enableGeometricalCorrection_allowed(Tango::AttReqType type);
/**
 *	Read/Write allowed for dacl attribute.
 */
	virtual bool is_dacl_allowed(Tango::AttReqType type);
/**
 *	Read/Write allowed for ithl attribute.
 */
	virtual bool is_ithl_allowed(Tango::AttReqType type);
/**
 *	Execution allowed for LoadFlatConfig command.
 */
	virtual bool is_LoadFlatConfig_allowed(const CORBA::Any &any);
/**
 *	Execution allowed for LoadAllConfigG command.
 */
	virtual bool is_LoadAllConfigG_allowed(const CORBA::Any &any);
/**
 *	Execution allowed for SaveConfigL command.
 */
	virtual bool is_SaveConfigL_allowed(const CORBA::Any &any);
/**
 *	Execution allowed for SaveConfigG command.
 */
	virtual bool is_SaveConfigG_allowed(const CORBA::Any &any);
/**
 *	Execution allowed for LoadConfig command.
 */
	virtual bool is_LoadConfig_allowed(const CORBA::Any &any);
/**
 *	Execution allowed for Reset command.
 */
	virtual bool is_Reset_allowed(const CORBA::Any &any);
/**
 *	Execution allowed for GetDacl command.
 */
	virtual bool is_GetDacl_allowed(const CORBA::Any &any);
/**
 *	Execution allowed for GetIthl command.
 */
	virtual bool is_GetIthl_allowed(const CORBA::Any &any);
/**
 *	Execution allowed for CalibrateOTNSlow command.
 */
	virtual bool is_CalibrateOTNSlow_allowed(const CORBA::Any &any);
/**
 *	Execution allowed for UploadCalibration command.
 */
	virtual bool is_UploadCalibration_allowed(const CORBA::Any &any);
/**
 *	Execution allowed for UploadWaitTimes command.
 */
	virtual bool is_UploadWaitTimes_allowed(const CORBA::Any &any);
/**
 *	Execution allowed for IncrementITHL command.
 */
	virtual bool is_IncrementITHL_allowed(const CORBA::Any &any);
/**
 *	Execution allowed for DecrementITHL command.
 */
	virtual bool is_DecrementITHL_allowed(const CORBA::Any &any);
/**
 * This command gets the device state (stored in its <i>device_state</i> data member) and returns it to the caller.
 *	@return	State Code
 *	@exception DevFailed
 */
	virtual Tango::DevState	dev_state();
/**
 * Load a Flat value to all pixels
 *	@param	argin	Flat value to be loaded
 *	@exception DevFailed
 */
	void	load_flat_config(Tango::DevULong);
/**
 * Load the config G(lobal) to a module and a chip
 *	@param	argin	modNum(1..8), chipId(0..6), config_values (11 values)
 *	@exception DevFailed
 */
	void	load_all_config_g(const Tango::DevVarULongArray *);
/**
 * ?
 *	@param	argin	modNum(1..8), calibId(0..6), chipId(0..7), curRow (0..119), values (80 values)
 *	@exception DevFailed
 */
	void	save_config_l(const Tango::DevVarULongArray *);
/**
 * ?
 *	@param	argin	modNum(1..8), calibId(0..6), reg, values (7 values)
 *	@exception DevFailed
 */
	void	save_config_g(const Tango::DevVarULongArray *);
/**
 * ?
 *	@param	argin	modNum(1..8), calibId(0..6)
 *	@exception DevFailed
 */
	void	load_config(const Tango::DevVarULongArray *);
/**
 * Reset the Xpad
 *	@exception DevFailed
 */
	void	reset();
/**
 * 
 *	@return	array of DACL data
 *	@exception DevFailed
 */
	Tango::DevVarUShortArray	*get_dacl();
/**
 * 
 *	@return	array of ITHL data
 *	@exception DevFailed
 */
	Tango::DevVarUShortArray	*get_ithl();
/**
 * Start the Over The Noise Slow calibration
 *	@exception DevFailed
 */
	void	calibrate_otnslow();
/**
 * Upload a calibration from a file defined in the property CalibrationPath
 *	@exception DevFailed
 */
	void	upload_calibration();
/**
 * Upload a tralectory of wait times, instead of having always the same value
 *	@param	argin	the wait times
 *	@exception DevFailed
 */
	void	upload_wait_times(const Tango::DevVarULongArray *);
/**
 * Increment the ITHL of 1 unit
 *	@exception DevFailed
 */
	void	increment_ithl();
/**
 * Decrement the ITHL of 1 unit
 *	@exception DevFailed
 */
	void	decrement_ithl();

/**
 *	Read the device properties from database
 */
	 void get_device_property();
//@}

        //	Here is the end of the automatic code generation part
        //-------------------------------------------------------------	
        // return true if the device is correctly initialized in init_device

        bool is_device_initialized()
        {
            return m_is_device_initialized;
        };


    protected:
        //	Add your own data members here
        //-----------------------------------------

        //- Store the values into the property
        //- Properties stuff    
        int                 find_index_from_property_name(Tango::DbData& dev_prop, string property_name);
        template <class T>
        void                create_property_if_empty(Tango::DbData& dev_prop,T value, string property_name);    
        template <class T>
        void                set_property(string property_name, T value);
        template <class T>
        T                   get_property(string property_name) ;

        
        bool m_is_device_initialized;
        stringstream m_status_message;
        void set_specific_parameters();

        //lima OBJECTS
        Xpad::Interface* m_hw;
        Xpad::Camera* m_camera;
        CtControl* m_ct;
    };

} // namespace_ns

#endif	// _XPADPIXELDETECTOR_H
